/*! 
 * Consistent.js 0.2.0
 * @author Karl von Randow
 * @license Apache License, Version 2.0
 */
!function(e,t){var n=e.Consistent=function(){var e=arguments[0];if(e!==t){if(n.isScope(e)){if(arguments[1]!==t){return n.createScope(e,arguments[1])}else{return n.createScope(e,null)}}else if(e.nodeName!==t){return n.findScopeForNode(e)}else if(typeof e=="object"){return n.createScope(null,e)}else{throw new b("Unexpected argument to Consistent(): "+e)}}else{return n.createScope(null,null)}};var i={};var r="ConsistentScope";var o=function(){var e={};var t=document.createElement("div");t.setAttribute("className","test");e.badGetSetAttribute=t.className==="test";return e}();p(n,{settings:{keyDataAttribute:"data-ct",showDataAttribute:"data-ct-show",hideDataAttribute:"data-ct-hide",templateDataAttribute:"data-ct-tmpl",templateIdDataAttribute:"data-ct-tmpl-id",attributeDataAttributePrefix:"data-ct-attr-",propertyDataAttributePrefix:"data-ct-prop-",templateAttributeDataAttributePrefix:"data-ct-tmpl-attr-",templateIdAttributeDataAttributePrefix:"data-ct-tmpl-id-attr-",bindDataAttribute:"data-ct-bind",bindDataAttributePrefix:"data-ct-bind-",repeatDataAttribute:"data-ct-rep",repeatContainerIdDataAttribute:"data-ct-rep-container-id",warningDataAttributePrefix:"data-ct-",repeatIndexProperty:"_ct_index",scopeIdKey:"__ConsistentScopeID",functionIdKey:"__ConsistentFunctionID",oldDisplayKey:"__ConsistentOldDisplay",maxWatcherLoops:100},isScope:function(e){return e!==t&&e.$!==t&&e.$._type===r},createScope:function(e,t){t=f({},n.defaultOptions,t);var r=new y(e,t);i[r._id]=r._scope;return r._scope},findScopeForNode:function(e){var t=e[n.settings.scopeIdKey];if(t&&i[t]){return i[t]}else{return null}},merge:p});var a={};function s(e){return a.toString.call(e)==="[object Array]"}function p(){var e=0;var n=false;if(typeof arguments[0]==="boolean"){n=arguments[0];e++}var i=arguments[e];if(typeof i!=="object"&&typeof i!=="function"){throw new b("First object argument to merge is not appropriate: "+typeof i)}if(i===null){throw new b("First object argument to merge is not appropriate: "+i)}for(var r=e+1;r<arguments.length;r++){var o=arguments[r];if(o===t){continue}if(typeof o!=="object"&&typeof o!=="function"){throw new b("Argument "+(r+1)+" to merge is not appropriate: "+typeof o)}for(var a in o){if(a==="$"){continue}var f=o[a];if(f!==t){if(n&&typeof f==="object"&&f!==null){f=p(true,s(f)?[]:{},f)}i[a]=f}}}return i}function f(){var e=[];for(var t=0;t<arguments.length;t++){var n=arguments[t];if(n){e.push(arguments[t].$)}}if(!e[0]){e[0]={}}var i=p.apply(this,arguments);i.$=p.apply(this,e);return i}function u(e){if(!o.badGetSetAttribute){return e}if(e==="class"){return"className"}else{return e}}function l(e,n){var i=n.split(".");var r=e;var o;for(o=0;o<i.length&&r!==t&&r!==null;o++){r=r[i[o]]}if(o==i.length){return r}else{return t}}function c(e,n,i){var r=n.split(".");var o=e;for(var a=0;a<r.length-1;a++){if(o[r[a]]===t){o[r[a]]={}}o=o[r[a]]}o[r[r.length-1]]=i}n.defaultOptions={templateEngine:null,autoListenToChange:true,$:{getNodeOptions:function(e,t){return n.getNodeOptions(e,t)},apply:function(e,n,i){var r;if(i.key){r=l(n,i.key);if(r!==t){this.setValue(e,r)}}else if(i.template!==t&&i.template!==null){this.setValue(e,i.template.render(n))}var o;if(i.attributes){var a=i.attributes;for(o=0;o<a.length;o++){if(a[o].key!==t){r=l(n,a[o].key)}else if(a[o].template!==t){r=a[o].template.render(n)}else{r=null}if(r!==t){this.setAttributeValue(e,a[o].name,r)}}}if(i.properties){var s=i.properties;for(o=0;o<s.length;o++){r=l(n,s[o].key);if(r!==t){this.setPropertyValue(e,s[o].name,r)}}}if(i.show){r=l(n,i.show);if(r!==t){if(r){this.show(e)}else{this.hide(e)}}}else if(i.hide){r=l(n,i.hide);if(r!==t){if(!r){this.show(e)}else{this.hide(e)}}}},afterApply:function(e,t){},setValue:function(e,t){var n=e.nodeName;if(n==="INPUT"||n==="TEXTAREA"){if(e.type==="checkbox"){e.checked=t?true:false}else if(e.type==="radio"){e.checked=t==e.value}else{e.value=t}}else if(n==="SELECT"){if(t===null){t=""}for(var i=0;i<e.options.length;i++){if(e.options[i].value==t){e.selectedIndex=i;break}}}else if(n==="IMG"){e.src=t}else{e.innerHTML=t}},setAttributeValue:function(e,t,n){t=u(t);if(n){e.setAttribute(t,n)}else{e.removeAttribute(t)}},setPropertyValue:function(e,t,n){c(e,t,n)},update:function(e,n,i){var r,o;if(i.key){r=this.getValue(e);if(r!==t){n.$.set(i.key,r)}}if(i.attributes){var a=i.attributes;for(o=0;o<a.length;o++){if(a[o].key!==t){r=this.getAttributeValue(e,a[o].name);n.$.set(a[o].key,r)}}}if(i.properties){var s=i.properties;for(o=0;o<s.length;o++){r=this.getPropertyValue(e,s[o].name);n.$.set(s[o].key,r)}}},getValue:function(e){var n=e.nodeName;if(n==="INPUT"||n==="TEXTAREA"){if(e.type==="checkbox"){return e.checked}else if(e.type==="radio"){return e.checked?e.value:t}else{return e.value}}else if(n==="SELECT"){return e.options[e.selectedIndex].value}else if(n==="IMG"){return e.src}else{return e.innerHTML}},getAttributeValue:function(e,t){t=u(t);return e.getAttribute(t)},getPropertyValue:function(e,t){return l(e,t)},show:function(e){if(e.style.display!=="none"){return}var i=e[n.settings.oldDisplayKey];if(i===t){i=""}e.style.display=i},hide:function(e){if(e.style.display==="none"){return}e[n.settings.oldDisplayKey]=e.style.display;e.style.display="none"},added:function(e){},remove:function(e){e.parentNode.removeChild(e)}}};n.defaultOptions.$.$original=n.defaultOptions.$;n.getNodeOptions=n.defaultGetNodeOptions=function(e,i){var r=f({},i);var o=e.nodeName;if(o==="INPUT"||o==="TEXTAREA"||o==="SELECT"){if(r.key===t){r.key=e.getAttribute("name")}}var a=n.settings;var s=e.attributes;for(var p=0;p<s.length;p++){var u=s[p].name;var l=s[p].value;var c,h,d;if(u==a.keyDataAttribute){r.key=l}else if(u.indexOf(a.attributeDataAttributePrefix)===0){c=u.substring(a.attributeDataAttributePrefix.length);_(c,l)}else if(u==a.templateDataAttribute){v();r.template=i.templateEngine.compile(l)}else if(u==a.templateIdDataAttribute){v();r.template=i.templateEngine.compile(m(l))}else if(u.indexOf(a.templateAttributeDataAttributePrefix)===0){v();c=u.substring(a.templateAttributeDataAttributePrefix.length);y(c,i.templateEngine.compile(l))}else if(u.indexOf(a.templateIdAttributeDataAttributePrefix)===0){v();c=u.substring(a.templateIdAttributeDataAttributePrefix.length);y(c,i.templateEngine.compile(m(l)))}else if(u.indexOf(a.propertyDataAttributePrefix)===0){h=u.substring(a.propertyDataAttributePrefix.length);h=h.replace(/-/g,".");A(h,l)}else if(u===a.bindDataAttribute){d=S(e);w(d,l)}else if(u.indexOf(a.bindDataAttributePrefix)===0){d=u.substring(a.bindDataAttributePrefix.length).toLowerCase();w(d,l)}else if(u===a.showDataAttribute){r.show=l}else if(u===a.hideDataAttribute){r.hide=l}else if(u===a.repeatDataAttribute){r.repeat=l}else if(u===a.repeatContainerIdDataAttribute){r.repeatContainerId=l}else if(u.indexOf(a.warningDataAttributePrefix)===0){if(console.log!==t){console.log('Warning: Unrecognised Consistent attribute "'+u+'" on '+e.nodeName+" element.")}}}function v(){if(!i.templateEngine){throw new b("templateEngine not configured in options")}}function m(e){var t=document.getElementById(e);if(t!==null){return t.innerHTML}else{throw new b("Template not found with id: "+e)}}function g(){if(r.attributes===t){r.attributes=[]}}function _(e,t){g();r.attributes.push({name:e,key:t})}function y(e,t){g();r.attributes.push({name:e,template:t})}function A(e,n){if(r.properties===t){r.properties=[]}r.properties.push({name:e,key:n})}function w(e,n){if(r.events===t){r.events={}}if(r.events[e]===t){r.events[e]={keys:[]}}r.events[e].keys.push(n)}function S(e){var t=e.nodeName;if(t==="INPUT"||t==="TEXTAREA"||t==="SELECT"){return"change"}else if(t==="FORM"){return"submit"}else{return"click"}}return r};n.defaultEmptyScope={$:{_type:r,_scope:null,_manager:null,apply:function(e,n){if(typeof e==="function"){n=e;e=t}if(n!==t){n.call(this._scope,e)}this._manager.apply(e);return this._scope},applyLater:function(n,i){if(typeof n==="function"){i=n;n=t}if(i!==t){i.call(this._scope,n)}e.clearTimeout(this._scope.$._applyLaterTimeout);var r=this;this._scope.$._applyLaterTimeout=e.setTimeout(function(){r._scope.$.apply(n)},0);return this._scope},needsApply:function(){return this._manager.needsApply()},update:function(){this._manager.update();return this._scope},bind:function(e,t){this._manager.bind(e,t);return this._scope},merge:function(e){return p(this._scope,e)},replace:function(e){return this._manager.replaceScope(e)},snapshot:function(){var e=this._scope.$.snapshotLocal();if(this._manager._parentScope){e=p(this._manager._parentScope.$.snapshot(),e)}return e},snapshotLocal:function(){var e=p(true,{},this._scope);for(var t in e){if(t.indexOf("$")===0){delete e[t]}else if(typeof e[t]==="function"){e[t]=e[t].call(this._scope)}}return e},nodes:function(){return this._manager._domNodes},roots:function(){return this._manager._rootDomNodes},parent:function(){return this._manager._parentScope},watch:function(e,t){this._manager.watch(e,t);return this._scope},unwatch:function(e,t){this._manager.unwatch(e,t);return this._scope},get:function(e){var n=this.getLocal(e);if(n!==t){return n}else if(this._manager._parentScope){return this._manager._parentScope.$.get(e)}else{return t}},getLocal:function(e,t){var n=l(this._scope,e);if(t&&typeof n==="function"){n=n.call(this._scope)}return n},set:function(e,n){var i=e.split(".");var r=this._scope;for(var o=0;o<i.length-1;o++){var a=r[i[o]];if(a===t){r=r[i[o]]={}}else{r=a}}r[i[i.length-1]]=n;return this._scope},getEventHandler:function(e){var n=this.getLocalEventHandler(e);if(n!==t){return n}else if(this._manager._parentScope){return this._manager._parentScope.$.getEventHandler(e)}else{return t}},getLocalEventHandler:function(e){e=h(e);return this.getLocal(e,false)},setEventHandler:function(e,t){e=h(e);return this.set(e,t)},options:function(e){return this._manager.getOptions(e)}}};function h(e){var t=e.split(".");var n="";for(var i=0;i<t.length-1;i++){n+=t[i]+"."}var r=t[t.length-1];if(r.indexOf("$")!==0){n+="$"+r}else{n+=r}return n}function d(e,n,i,r,o,a){if(i===t){i=""}if(r===t){r=0}if(o===t){o=[]}if(a===t){a=[]}if(a.indexOf(e)!==-1||a.indexOf(n)!==-1){return o}a.push(e);a.push(n);var s;for(s in e){if(e[s]!==n[s]){if(typeof e[s]==="object"&&typeof n[s]==="object"){d(e[s],n[s],i+s+".",r+1,o,a)}else{o.push(i+s)}}}for(s in n){if(e[s]===t){o.push(i+s)}}return o}function v(e){var t=f({},e);t.$._scope=t;return t}y.prototype=new Object;var m=0;var g=0;var _="$all";function y(e,t){this._id="ConsistentScope"+m;m++;this._parentScope=e;this._options=t;this._nodes=[];this._domNodes=[];this._rootDomNodes=[];this._watchers={};this._nodesDirty=false;this._applying=false;this._scope=f({},n.defaultEmptyScope);this._scope.$._manager=this;this._scope.$._scope=this._scope;this._cleanScopeSnapshot=this._scope.$.snapshot()}y.prototype.apply=function(e){if(this._applying){return}this._applying=true;if(this._updateCleanScopeAndFireWatchers()||this._nodesDirty){var n=this._nodes.length;for(var i=0;i<n;i++){var r=this._nodes[i];var o=e!==t?f({},r.options,e):r.options;o.$.apply(r.dom,this._cleanScopeSnapshot,o);if(o.repeat){this._handleRepeat(r,o,this._cleanScopeSnapshot)}}this._nodesDirty=false;if(this._parentScope){this._parentScope.$.apply(e)}var a=e!==t?f({},this._options,e):this._options;a.$.afterApply(this._scope,this._cleanScopeSnapshot)}this._applying=false};y.prototype._handleRepeat=function(e,i,r){var o=i.repeat;var a;var s=e.repeatData;if(s===t){s={version:0,items:[]};if(i.repeatContainerId){var p=document.getElementById(i.repeatContainerId);if(p!==null){s.domNodes=p.children}else{throw new b("Couldn't find element with id \""+i.repeatId+'" for repeat container.')}}else{s.domNodes=[e.dom.cloneNode(true)]}for(a=0;a<s.domNodes.length;a++){s.domNodes[a].removeAttribute(n.settings.repeatDataAttribute);s.domNodes[a].removeAttribute(n.settings.repeatContainerIdDataAttribute)}e.repeatData=s;var f=document.createComment("Consistent repeat "+o);e.dom.parentNode.insertBefore(f,e.dom);e.dom.parentNode.removeChild(e.dom);f[n.settings.scopeIdKey]=this._id;e.dom=f;s.insertBefore=document.createComment("/Consistent repeat "+o);e.dom.parentNode.insertBefore(s.insertBefore,f.nextSibling)}var u=this._scope.$.get(o);var c=l(r,o);if(c===t){return}if(typeof c!=="object"){throw new b('Repeat for key "'+o+'" is not an object in the scope, found '+typeof c)}s.version++;var h=s.version;var d=s.insertBefore;var v=null;var m;for(a=0;a<u.length;a++){var g=u[a];m=S(g);var _=false;if(m===t){var y=$();var A=n(this._scope,this._options);A.$.bind(y);A=A.$.replace(g);A[n.settings.repeatIndexProperty]=a;m={object:g,domNodes:y,scope:A,version:h};s.items.push(m);_=true}else{m.version=h}N(m.domNodes,d,d.parentNode);if(_){for(var w=0;w<m.domNodes.length;w++){i.$.added(m.domNodes[w])}}m.after=v;v=m.domNodes[m.domNodes.length-1];m.scope.$.apply()}for(a=0;a<s.items.length;a++){m=s.items[a];if(m.version!==h){if(m.after){N(m.domNodes,m.after.nextSibling,d.parentNode)}D(m.domNodes);s.items.splice(a,1);a--}}function S(e){for(var n=0;n<s.items.length;n++){if(s.items[n].object===e){return s.items[n]}}return t}function $(){var e=[];for(var t=0;t<s.domNodes.length;t++){e.push(s.domNodes[t].cloneNode(true))}return e}function D(e){for(var t=0;t<e.length;t++){i.$.remove(e[t])}}function N(e,t,n){for(var i=0;i<e.length;i++){n.insertBefore(e[i],t)}}};y.prototype.update=function(){var e=this._nodes.length;for(var t=0;t<e;t++){var n=this._nodes[t];n.options.$.update(n.dom,this._scope,n.options)}};y.prototype.needsApply=function(){if(this._nodesDirty){return true}return this.isDirty()};y.prototype.isDirty=function(){return d(this._scope.$.snapshot(),this._cleanScopeSnapshot).length!==0};y.prototype._updateCleanScopeAndFireWatchers=function(){var e=false;var t;var i=true;var r=0;var o=this._cleanScopeSnapshot;var a={};while(i){var s=this._scope.$.snapshot();t=[];while(i){i=false;if(r>=n.settings.maxWatcherLoops){throw new b("Too many loops while notifying watchers. There is likely to be an infinite loop caused by watcher functions continously changing the scope. You may otherwise increase Consistent.settings.maxWatcherLoops if this is not the case.")}var p=d(s,o);for(var f=0;f<p.length;f++){var u=p[f];if(t.indexOf(u)===-1){t.push(u)}i|=this._notifyWatchers(u,l(s,u),l(o,u),this._scope,a)}r++}if(t.length>0){i|=this._notifyWatchAlls(t,this._scope,s,o,a);e=true}o=s}if(e){this._cleanScopeSnapshot=this._scope.$.snapshot();return true}else{return false}};y.prototype._notifyWatchers=function(e,i,r,o,a){var s=false;var p=this._watchers[e];if(p!==t){for(var f=0;f<p.length;f++){var u=a[e];if(u===t){a[e]=u={}}var l=p[f];var c=l[n.settings.functionIdKey];if(c===t){c=l[n.settings.functionIdKey]="ConsistentFunction"+g;g++}if(u[c]===t||u[c].cleanValue!==i){l.call(o,e,i,r);u[c]={cleanValue:o.$.get(e)};s=true}}}if(this._parentScope){this._parentScope.$._manager._notifyWatchers(e,i,r,o,a)}return s};y.prototype._notifyWatchAlls=function(e,i,r,o,a){var s=false;var p=this._watchers[_];if(p!==t){for(var f=0;f<p.length;f++){var u=a[_];if(u===t){a[_]=u={}}var l=p[f];var c=l[n.settings.functionIdKey];if(c===t){c=l[n.settings.functionIdKey]="ConsistentFunction"+g;g++}if(u[c]===t||d(r,u[c].cleanScopeSnapshot).length!==0){p[f].call(i,e,r,o);u[c]={cleanScopeSnapshot:i.$.snapshot()};s=true}}}if(this._parentScope){this._parentScope.$._manager._notifyWatchAlls(e,i,r,o,a)}return s};y.prototype.bind=function(e,i,r){if(s(e)){for(var o=0;o<e.length;o++){this.bind(e[o],i,r)}return}if(e[n.settings.scopeIdKey]!==this._id){var a=f({},this._options,i);a=a.$.getNodeOptions(e,a);this._nodes.push({dom:e,options:a});this._domNodes.push(e);if(r===t){this._rootDomNodes.push(e)}this._nodesDirty=true;e[n.settings.scopeIdKey]=this._id;var p=this;for(var u in a.events){!function(n,i){var r=function(r){for(var o=0;o<i.length;o++){var a=i[o];var s=p._scope.$.getEventHandler(a);if(s!==t){var f=s.call(e,r,p._scope);if(f===false)break}else{r.preventDefault();s=p._scope.$.get(a);if(typeof s==="function"){throw new b('Bound "'+n+'" event wanted scope function in key "'+h(a)+'", there was one in "'+a+'" which is missing the $ and is possibly a mistake.')}else{throw new b('Bound "'+n+'" event wanted scope function in key "'+h(a)+'"')}}}};a.events[n].listener=r;if(e.addEventListener){e.addEventListener(n,r,false)}else if(e.attachEvent){e.attachEvent("on"+n,r)}else{throw new b("Unable to attach event to DOM node. Cannot find supported method.")}}(u,a.events[u].keys)}var l=e.nodeName;if(a.autoListenToChange&&(l==="INPUT"||l==="TEXTAREA"||l==="SELECT")){var c=function(t){a.$.update(e,p._scope,a);p._scope.$.apply()};e.addEventListener("change",c,false);a.$._changeListener=c}}var d=e.firstChild;while(d!==null){if(d.nodeType===1){this.bind(d,i,e)}d=d.nextSibling}};y.prototype.unbind=function(e){var n=this._domNodes.indexOf(e);if(n!==-1){var i=this._nodes[n];var r=i.options;for(var o in r.events){e.removeEventListener(o,r.events[o].listener,false)}if(r.$._changeListener!==t){e.removeEventListener("change",r.$._changeListener,false)}this._domNodes.slice(n,1);this._nodes.slice(n,1)}var a=e.firstChild;while(a!==null){if(a.nodeType===1){this.unbind(a)}a=a.nextSibling}};y.prototype.nodes=function(){return _domNodes};y.prototype.watch=function(e,n){if(typeof e==="function"&&n===t){n=e;e=_}var i=this._watchers[e];if(i===t){i=[];this._watchers[e]=i}i.push(n)};y.prototype.unwatch=function(e,n){if(typeof e==="function"&&n===t){n=e;e=_}var i=this._watchers[e];if(i!==t){var r=i.indexOf(n);i.splice(r,1)}};y.prototype.getOptions=function(e){for(var t=0;t<this._nodes.length;t++){if(this._nodes[t].dom===e){return this._nodes[t].options}}return null};y.prototype.replaceScope=function(e){e.$=this._scope.$;e.$._scope=e;this._scope=e;return e};b.prototype=new Error;function b(e){this._message=e}b.prototype.toString=function(){return"Consistent.js exception: "+this._message}}(window);if(!("indexOf"in Array.prototype)){Array.prototype.indexOf=function(e,t){if(t===undefined)t=0;if(t<0)t+=this.length;if(t<0)t=0;for(var n=this.length;t<n;t++){if(t in this&&this[t]===e){return t}}return-1}}